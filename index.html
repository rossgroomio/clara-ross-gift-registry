<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clara & Ross's Gift Registry</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚ù§Ô∏è</text></svg>">
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body>
    <div id="root"></div>
    
    <script>
        // Replace with your Firebase config
        const firebaseConfig = {
          apiKey: "AIzaSyCSkzRczHX9dLjd7ZPk31NfuaQeD7sy_kk",
          authDomain: "clara-ross-gift-registry.firebaseapp.com",
          databaseURL: "https://clara-ross-gift-registry-default-rtdb.europe-west1.firebasedatabase.app",
          projectId: "clara-ross-gift-registry",
          storageBucket: "clara-ross-gift-registry.firebasestorage.app",
          messagingSenderId: "75526395782",
          appId: "1:75526395782:web:63cea957ced9f951effe07"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        window.firebaseDB = firebase.database();
    </script>
    
    <script>
        const { useState, useEffect } = React;

        function WeddingGiftRegistry() {
          const [items, setItems] = useState([]);
          const [filter, setFilter] = useState('all');
          const [guestName, setGuestName] = useState('');
          const [showContributionModal, setShowContributionModal] = useState(false);
          const [selectedItem, setSelectedItem] = useState(null);
          const [contributionAmount, setContributionAmount] = useState('');
          const [showAdminPanel, setShowAdminPanel] = useState(false);
          const [loading, setLoading] = useState(true);
          const [saving, setSaving] = useState(false);
          const [error, setError] = useState(null);

          // Clara & Ross's Wedding Gift List
          const giftItems = [
            { id: 1, item: "Outdoor cushion storage box", price: 249.99, url: "https://www.tatesofsussex.co.uk/shop/products/outdoor-living/garden-storage/storage-boxes/storage-box-570-litre.html" },
            { id: 2, item: "Pendant light", price: 250.00, url: "https://www.nkuku.com/products/chakai-wood-metal-pendant-large-cp05" },
            { id: 3, item: "Bedside lamp #1", price: 40.00, url: "https://www.johnlewis.com/john-lewis-isabel-mini-touch-table-lamp/antique-brass/p6092035" },
            { id: 4, item: "Bedside lamp #2", price: 40.00, url: "https://www.johnlewis.com/john-lewis-isabel-mini-touch-table-lamp/antique-brass/p6092035" },
            { id: 5, item: "Living room side table [50cm]", price: 150.00, url: "https://theindustrialfurniture.co.uk/products/mushroom-wooden-round-coffee-table-wood-end-table-side-table-solid-wood-coffee-table-40cm-50cm-60cm?srsltid=AfmBOoqfsLsXgEgcKFa-wa9iXCFdCxfPHwct0dxVv3h9rvJyvdckLa_X&variant=43090121130172" },
            { id: 6, item: "Rug (152 x 244cm)", price: 498.00, url: "https://www.anthropologie.com/en-gb/shop/hybrid/matilda-goad-co-tufted-plaid-rug?color=048&size=152cm+x+244cm&type=REGULAR&inventoryCountry=GB&countryCode=GB&currency=GBP&epik=dj0yJnU9Q1JMSUNYUXpDcjh2NW9aTTFfU19MUW9oZVRwWW51dVQmcD0wJm49OXAwZm55Nnc0NmdkdVJ2d3ZkWHFTZyZ0PUFBQUFBR2hxS2tV&quantity=1" },
            { id: 7, item: "Window seat cushion - Honey Pot Clever Velvet (30x60cm) #1", price: 69.00, url: "https://loaf.com/products/scatter-cushions?colour=honey-pot-clever-velvet&size=30-x-60-cm" },
            { id: 8, item: "Window seat cushion - Honey Pot Clever Velvet (30x60cm) #2", price: 69.00, url: "https://loaf.com/products/scatter-cushions?colour=honey-pot-clever-velvet&size=30-x-60-cm" },
            { id: 9, item: "Window seat cushion - Honey Pot Clever Velvet (30x60cm) #3", price: 69.00, url: "https://loaf.com/products/scatter-cushions?colour=honey-pot-clever-velvet&size=30-x-60-cm" },
            { id: 10, item: "Window seat cushion - Honey Pot Clever Velvet (30x60cm) #4", price: 69.00, url: "https://loaf.com/products/scatter-cushions?colour=honey-pot-clever-velvet&size=30-x-60-cm" },
            { id: 11, item: "Window seat cushion - Honey Pot Clever Velvet (30x60cm) #5", price: 69.00, url: "https://loaf.com/products/scatter-cushions?colour=honey-pot-clever-velvet&size=30-x-60-cm" },
            { id: 12, item: "Bath towel (bath sheet, ink) #1", price: 45.00, url: "https://pandalondon.com/products/towels?variant=49082134790470" },
            { id: 13, item: "Bath towel (bath sheet, ink) #2", price: 45.00, url: "https://pandalondon.com/products/towels?variant=49082134790470" },
            { id: 14, item: "Duvet cover (white; double)", price: 110.00, url: "https://www.thewhitecompany.com/uk/Savoy-Egyptian-Cotton-Bed-Linen-Collection/p/savoy-bed-linen-collection/g/savoy-dv?swatch=White&irclickid=2zXys11KAxycRUQSIpw5s0PyUksSTKVE-0VQSs0&sharedid=goodhousekeeping.co.uk&irpid=10078&utm_source=Affiliates&utm_medium=ImpactUK&CM_MMC=Affiliates-_-Skimbit%20Ltd.-_-ImpactUK-_-%22Editorial%22&ProGrpCode=EUBB970&PromoCode=EUBB970&pid=impactradius_int&af_siteid=10078&af_media_type=2016291&is_retargeting=true&af_reengagement_window=30d&af_click_lookback=7d&clickid=2zXys11KAxycRUQSIpw5s0PyUksSTKVE-0VQSs0&af_sub_siteid=Skimbit%20Ltd.&im_ref=2zXys11KAxycRUQSIpw5s0PyUksSTKVE-0VQSs0&irgwc=1" },
            { id: 15, item: "Fitted bed sheet (king)", price: 70.00, url: "https://www.thewhitecompany.com/uk/Savoy-Egyptian-Cotton-Bed-Linen-Collection/p/savoy-bed-linen-collection/g/Savoy-FS?swatch=White" },
            { id: 16, item: "Pillow case (standard) #1", price: 22.00, url: "https://www.thewhitecompany.com/uk/Savoy-Egyptian-Cotton-Bed-Linen-Collection/p/savoy-bed-linen-collection/g/Savoy-PC-CL?swatch=White" },
            { id: 17, item: "Pillow case (standard) #2", price: 22.00, url: "https://www.thewhitecompany.com/uk/Savoy-Egyptian-Cotton-Bed-Linen-Collection/p/savoy-bed-linen-collection/g/Savoy-PC-CL?swatch=White" },
            { id: 18, item: "Nursing chair (boucle biscuit)", price: 399.00, url: "https://www.tuttibambini.com/products/micah-rocking-chair-and-foot-stool-boucle-biscuit?variant=53769822208325" } 
          ];

          // Add this function after the giftItems array
          function sanitizeInput(input) {
            if (typeof input !== 'string') return input;
          
            return input
              .trim()                                    // Remove whitespace
              .replace(/[<>]/g, '')                     // Remove < and >
              .replace(/javascript:/gi, '')             // Remove javascript: URLs
              .replace(/on\w+=/gi, '')                  // Remove event handlers
              .substring(0, 100);                       // Limit length
          }

          // Initialize Firebase connection
          useEffect(() => {
            loadDataFromFirebase();
            
            // Set up real-time listener if Firebase is configured
            if (window.firebaseDB) {
              const contributionsRef = window.firebaseDB.ref('contributions');
              const listener = contributionsRef.on('value', (snapshot) => {
                loadDataFromFirebase();
              });
              
              return () => contributionsRef.off('value', listener);
            }
          }, []);

          async function loadDataFromFirebase() {
            setLoading(true);
            setError(null);

            try {
              if (!window.firebaseDB) {
                throw new Error('Firebase not configured');
              }

              const contributionsRef = window.firebaseDB.ref('contributions');
              const snapshot = await contributionsRef.once('value');
              const contributionsData = snapshot.val() || {};
              
              // Convert Firebase object to array
              const contributions = Object.keys(contributionsData).map(key => ({
                id: key,
                ...contributionsData[key]
              }));

              // Merge contributions with items
              const itemsWithContributions = giftItems.map(item => {
                const itemContributions = contributions.filter(contrib => contrib.itemId === item.id);
                const totalContributed = itemContributions.reduce((sum, contrib) => sum + contrib.amount, 0);
                return {
                  ...item,
                  contributions: itemContributions,
                  purchased: totalContributed >= item.price
                };
              });

              setItems(itemsWithContributions);
            } catch (err) {
              console.error('Error loading from Firebase:', err);
              setError('Firebase not configured - running in demo mode');
              
              // Fallback to local data
              const itemsWithContributions = giftItems.map(item => ({
                ...item,
                contributions: [],
                purchased: false
              }));
              setItems(itemsWithContributions);
            } finally {
              setLoading(false);
            }
          }

          async function saveContributionToFirebase(itemId, name, amount) {
            try {
              if (!window.firebaseDB) {
                throw new Error('Firebase not configured');
              }

              const contribution = {
                itemId,
                name,
                amount,
                timestamp: new Date().toISOString()
              };

              const contributionsRef = window.firebaseDB.ref('contributions');
              await contributionsRef.push(contribution);
              
              console.log('Contribution saved to Firebase:', contribution);
            } catch (err) {
              console.error('Error saving to Firebase:', err);
              throw err;
            }
          }

          // Enhanced function to update payment status
          async function updatePaymentStatus(contributionId, newStatus) {
            console.log('Attempting to update payment status:', { contributionId, newStatus });
            
            try {
              if (!window.firebaseDB) {
                throw new Error('Firebase not configured');
              }

              if (!contributionId) {
                throw new Error('Contribution ID is required');
              }

              console.log('Firebase connection exists, updating contribution:', contributionId);
              
              const contributionRef = window.firebaseDB.ref(`contributions/${contributionId}`);
              
              // First check if the contribution exists
              const snapshot = await contributionRef.once('value');
              if (!snapshot.exists()) {
                throw new Error(`Contribution ${contributionId} not found in database`);
              }
              
              console.log('Contribution found, updating status...');
              
              await contributionRef.update({ 
                status: newStatus,
                statusUpdatedAt: new Date().toISOString()
              });
              
              console.log(`Payment status updated to ${newStatus} for contribution ${contributionId}`);
              return true;
              
            } catch (err) {
              console.error('Error updating payment status:', {
                error: err,
                message: err.message,
                contributionId,
                newStatus,
                firebaseConnected: !!window.firebaseDB
              });
              throw new Error(`Failed to update payment status: ${err.message}`);
            }
          }

          useEffect(() => {
            // Add keyboard shortcut to toggle admin panel (Ctrl+Shift+A)
            function handleKeyPress(e) {
              if (e.ctrlKey && e.shiftKey && e.key === 'A') {
                setShowAdminPanel(!showAdminPanel);
              }
            }
            
            window.addEventListener('keydown', handleKeyPress);
            return () => window.removeEventListener('keydown', handleKeyPress);
          }, [showAdminPanel]);

          function getTotalContributed(item) {
            return item.contributions
              .filter(contrib => {
                // If no status field exists, treat as confirmed (backward compatibility)
                // Only exclude pending_payment status
                return !contrib.status || contrib.status === 'paid' || contrib.status === 'confirmed';
              })
              .reduce((sum, contrib) => sum + contrib.amount, 0);
          }

          function getTotalPledged(item) {
            // Include ALL contributions regardless of payment status
            return item.contributions.reduce((sum, contrib) => sum + contrib.amount, 0);
          }

          function getRemainingAmount(item) {
            const contributed = getTotalContributed(item);
            const remaining = item.price - contributed;
            // Handle floating point precision issues
            return Math.max(0, Math.round(remaining * 100) / 100);
          }

          function getRemainingToPledge(item) {
            const pledged = getTotalPledged(item);
            const remaining = item.price - pledged;
            // Handle floating point precision issues
            return Math.max(0, Math.round(remaining * 100) / 100);
          }

          function getProgressPercentage(item) {
            return Math.min(100, (getTotalContributed(item) / item.price) * 100);
          }

          function isFullyPledged(item) {
            return getRemainingToPledge(item) === 0;
          }

          const filteredItems = items.filter(item => {
            const fullyPledged = isFullyPledged(item);
              
            if (filter === 'available') return !fullyPledged;
            if (filter === 'purchased') return fullyPledged;
            return true;
          });

          async function handleContribution() {
            console.log('üöÄ === HANDLE CONTRIBUTION START ===');
            
            if (!guestName || !contributionAmount || !selectedItem) {
              console.log('‚ùå Early return: missing data', { 
                guestName: !!guestName, 
                contributionAmount: !!contributionAmount, 
                selectedItem: !!selectedItem 
              });
              return;
            }

            console.log('‚úÖ Initial validation passed');

            const cleanName = guestName.trim();
            const amount = parseFloat(contributionAmount);
            
            console.log('üìù Parsed values:', { cleanName, amount, originalAmount: contributionAmount });
            
            // Basic validation
            if (cleanName.length < 2 || cleanName.length > 50) {
              console.log('‚ùå Name validation failed:', cleanName.length);
              setError('Name must be 2-50 characters');
              return;
            }
            
            if (amount < 0.01 || amount > 1000) {
              console.log('‚ùå Amount validation failed:', amount);
              setError('Amount must be between ¬£0.01 and ¬£1000');
              return;
            }

            console.log('‚úÖ Basic validation passed');

            const remaining = getRemainingToPledge(selectedItem);
            
            if (remaining <= 0) {
              console.log('‚ùå Item fully pledged, remaining:', remaining);
              setError('This item has already been fully pledged! Please refresh the page.');
              return;
            }
            
            const actualAmount = Math.min(amount, remaining);
            
            console.log('üí∞ Amount calculations:', { 
              requested: amount, 
              remaining, 
              actualAmount,
              selectedItemId: selectedItem.id,
              selectedItemName: selectedItem.item
            });
            
            // Warn user if their contribution will be reduced
            if (actualAmount < amount) {
              const reduction = amount - actualAmount;
              const confirmMessage = `This item only needs ¬£${remaining.toFixed(2)} more to be fully funded.\n\nYour contribution will be reduced from ¬£${amount.toFixed(2)} to ¬£${actualAmount.toFixed(2)}.\n\nProceed with ¬£${actualAmount.toFixed(2)}?`;
              
              if (!confirm(confirmMessage)) {
                console.log('‚ùå User cancelled amount reduction');
                return;
              }
              console.log('‚úÖ User accepted amount reduction');
            }

            console.log('üí≥ About to show payment method dialog');

            // Payment method selection
            const paymentMethod = confirm(
              `Choose your payment method for ¬£${actualAmount.toFixed(2)}:\n\n` +
              `OK = PayPal (opens paypal.me link)\n` +
              `Cancel = Bank Transfer (shows account details)`
            );

            console.log('üí≥ Payment method selected:', paymentMethod ? 'PayPal' : 'Bank Transfer');

            setSaving(true);
            setError(null);

            console.log('üîÑ About to enter try block');
            console.log('üî• Firebase status:', {
              firebaseDB: !!window.firebaseDB,
              firebaseType: typeof window.firebaseDB,
              firebaseKeys: window.firebaseDB ? Object.keys(window.firebaseDB) : 'none'
            });

            try {
              // Record the contribution intent in Firebase
              const contributionIntent = {
                itemId: selectedItem.id,
                itemName: selectedItem.item,
                name: cleanName,
                amount: actualAmount,
                status: 'pending_payment',
                paymentMethod: paymentMethod ? 'paypal' : 'bank_transfer',
                timestamp: new Date().toISOString()
              };

              console.log('üì¶ === CONTRIBUTION DEBUG ===');
              console.log('üì¶ Contribution data being sent:', contributionIntent);
              console.log('üì¶ Data types:', {
                itemId: typeof contributionIntent.itemId,
                itemName: typeof contributionIntent.itemName,
                name: typeof contributionIntent.name,
                amount: typeof contributionIntent.amount,
                status: typeof contributionIntent.status,
                paymentMethod: typeof contributionIntent.paymentMethod,
                timestamp: typeof contributionIntent.timestamp
              });
              console.log('üì¶ Data values:', {
                itemId: contributionIntent.itemId,
                itemName: contributionIntent.itemName.substring(0, 20) + '...',
                name: contributionIntent.name,
                amount: contributionIntent.amount,
                status: contributionIntent.status,
                paymentMethod: contributionIntent.paymentMethod,
                timestamp: contributionIntent.timestamp
              });
              console.log('üì¶ Firebase connected:', !!window.firebaseDB);
              console.log('üì¶ ========================');

              console.log('üîó Getting Firebase contributions reference...');
              const contributionsRef = window.firebaseDB.ref('contributions');
              console.log('üîó Firebase ref created:', !!contributionsRef);
              
              console.log('üíæ About to call contributionsRef.push()...');
              const newContribRef = await contributionsRef.push(contributionIntent);
              console.log('‚úÖ Firebase push successful! New ref:', !!newContribRef);

              if (paymentMethod) {
                console.log('üí≥ Processing PayPal flow...');
                // PayPal flow
                const paypalMeURL = `https://paypal.me/rossgroom/${actualAmount.toFixed(2)}?country.x=GB&locale.x=en_GB`;
                console.log('üí≥ PayPal URL generated:', paypalMeURL);
                
                const paymentMessage = `You'll now be redirected to PayPal to complete your ¬£${actualAmount.toFixed(2)} contribution for "${selectedItem.item}".\n\nYour contribution will show as confirmed once we have received it.\n\nReady to proceed?`;
                
                if (confirm(paymentMessage)) {
                  console.log('üí≥ Opening PayPal window...');
                  window.open(paypalMeURL, '_blank', 'noopener,noreferrer');
                  
                  console.log('üí≥ Closing modal and resetting form...');
                  setShowContributionModal(false);
                  setGuestName('');
                  setContributionAmount('');
                  setSelectedItem(null);
                  
                  alert('Thank you! Please complete your payment in the PayPal window that just opened. Your contribution will appear here once payment is confirmed.');
                  console.log('‚úÖ PayPal flow completed successfully');
                } else {
                  console.log('‚ùå User cancelled PayPal payment, removing contribution...');
                  await newContribRef.remove();
                  console.log('‚úÖ Contribution removed');
                }
              } else {
                console.log('üè¶ Processing Bank Transfer flow...');
                // Bank transfer flow
                const bankDetails = 
                  `Bank Transfer Details:\n\n` +
                  `Account Holder: Ross Groom\n` +
                  `Sort Code: 04-00-03\n` +
                  `Account Number: 81193421\n` +
                  `Amount: ¬£${actualAmount.toFixed(2)}\n\n` +
                  `Reference: ${selectedItem.id}-${cleanName}\n\n` +
                  `Please use the reference above to help us identify your payment.\n\n` +
                  `Your contribution will show as confirmed once we have received it.`;

                alert(bankDetails);
                
                // Copy bank details to clipboard if possible
                try {
                  const clipboardText = 
                    `Bank Transfer to Ross Groom\n` +
                    `Sort Code: 04-00-03\n` +
                    `Account Number: 81193421\n` +
                    `Amount: ¬£${actualAmount.toFixed(2)}\n` +
                    `Reference: ${selectedItem.id}-${cleanName}`;
                  
                  await navigator.clipboard.writeText(clipboardText);
                  console.log('üìã Bank details copied to clipboard');
                  alert('Bank details copied to clipboard!');
                } catch (e) {
                  console.log('üìã Clipboard not available:', e.message);
                }

                console.log('üè¶ Closing modal and resetting form...');
                setShowContributionModal(false);
                setGuestName('');
                setContributionAmount('');
                setSelectedItem(null);
                console.log('‚úÖ Bank transfer flow completed successfully');
              }
              
            } catch (err) {
              console.error('üí• === CONTRIBUTION ERROR ===');
              console.error('üí• Error details:', {
                name: err.name,
                message: err.message,
                code: err.code,
                stack: err.stack?.substring(0, 500)
              });
              console.error('üí• Full error object:', err);
              console.error('üí• ========================');
              
              setError('Failed to process contribution. Please try again.');
              console.error('Contribution error:', err);
            } finally {
              console.log('üîÑ Setting saving to false...');
              setSaving(false);
              console.log('üèÅ === HANDLE CONTRIBUTION END ===');
            }
          }

          function openContributionModal(item) {
            setSelectedItem(item);
            setShowContributionModal(true);
          }

          if (loading) {
            return React.createElement('div', {
              className: "min-h-screen bg-gradient-to-br from-rose-50 to-pink-100 flex items-center justify-center",
              style: { fontFamily: 'system-ui, sans-serif' }
            }, 
              React.createElement('div', { className: "text-center" },
                React.createElement('div', {
                  className: "w-8 h-8 border-4 border-rose-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"
                }),
                React.createElement('p', { className: "text-gray-600" }, "Loading gift registry...")
              )
            );
          }

          // Create the main content
          const mainContent = React.createElement('div', {
            className: "min-h-screen bg-gradient-to-br from-rose-50 to-pink-100 p-4",
            style: { fontFamily: 'system-ui, sans-serif' }
          }, 
            React.createElement('div', { className: "max-w-6xl mx-auto" },
              // Header
              React.createElement('div', {
                className: "text-center mb-8 bg-white rounded-lg shadow-lg p-8"
              },
                React.createElement('div', { className: "flex justify-center mb-4" }, 
                  React.createElement('div', { className: "text-4xl" }, "‚ù§Ô∏è")
                ),
                React.createElement('h1', { className: "text-4xl font-bold text-gray-800 mb-2" }, "Clara & Ross's"),
                React.createElement('h2', { className: "text-2xl text-rose-600 mb-4" }, "Gift Registry"),
                React.createElement('p', { className: "text-gray-600 max-w-2xl mx-auto" }, 
                  "Thank you for coming to our event and celebrating our marriage and new arrival! Our event on 16th August at The Bat and Ball pub in Billingshurst is only small and we don't expect anything. But if you really do insist you can contribute any amount toward the gifts below."
                ),
                error && React.createElement('div', {
                  className: "mt-4 p-3 bg-yellow-100 border border-yellow-300 rounded-md"
                },
                  React.createElement('p', { className: "text-yellow-800 text-sm" }, error),
                  React.createElement('button', {
                    onClick: loadDataFromFirebase,
                    className: "mt-2 text-yellow-800 underline text-sm hover:no-underline"
                  }, "Try refreshing")
                )
              ),

              // Connection Status
              React.createElement('div', { className: "text-center mb-4" },
                React.createElement('div', { className: "inline-flex items-center space-x-2 text-sm" },
                  React.createElement('div', {
                    className: `w-2 h-2 rounded-full ${window.firebaseDB ? 'bg-green-500' : 'bg-yellow-500'}`
                  }),
                  React.createElement('span', { className: "text-gray-600" }, 
                    window.firebaseDB ? 'Connected to Firebase' : 'Demo mode - Firebase not configured'
                  )
                )
              ),

              // Filter Buttons
              React.createElement('div', { className: "flex justify-center mb-6 space-x-4" },
                React.createElement('button', {
                  onClick: () => setFilter('all'),
                  className: `px-6 py-2 rounded-full font-medium transition-colors ${
                    filter === 'all' 
                      ? 'bg-rose-500 text-white' 
                      : 'bg-white text-gray-600 hover:bg-rose-100'
                  }`
                }, `All Items (${items.length})`),
                React.createElement('button', {
                  onClick: () => setFilter('available'),
                  className: `px-6 py-2 rounded-full font-medium transition-colors ${
                    filter === 'available' 
                      ? 'bg-rose-500 text-white' 
                      : 'bg-white text-gray-600 hover:bg-rose-100'
                  }`
                }, `Available (${items.filter(item => !isFullyPledged(item)).length})`),
                React.createElement('button', {
                  onClick: () => setFilter('purchased'),
                  className: `px-6 py-2 rounded-full font-medium transition-colors ${
                    filter === 'purchased' 
                      ? 'bg-rose-500 text-white' 
                      : 'bg-white text-gray-600 hover:bg-rose-100'
                  }`
                }, `Fulfilled (${items.filter(item => isFullyPledged(item)).length})`)
              ),

              // Gift Items Grid
              React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" },
                ...filteredItems.map((item) => {
                  const totalContributed = getTotalContributed(item);
                  const remaining = getRemainingAmount(item);
                  const progress = getProgressPercentage(item);
                  const isFullyFunded = remaining === 0 || item.purchased;

                  return React.createElement('div', {
                    key: item.id,
                    className: "bg-white rounded-lg shadow-lg overflow-hidden hover:shadow-xl transition-shadow"
                  },
                    React.createElement('div', { className: "p-6" },
                      // Item header
                      React.createElement('div', { className: "flex justify-between items-start mb-3" },
                        React.createElement('h3', { className: "text-lg font-semibold text-gray-800 leading-tight" }, item.item),
                        isFullyFunded && React.createElement('span', { className: "text-green-500 text-xl" }, "‚úì")
                      ),
                      
                      // Progress section
                      React.createElement('div', { className: "mb-4" },
                        React.createElement('div', { className: "flex justify-between text-sm text-gray-600 mb-1" },
                          React.createElement('span', {}, `Goal: ¬£${item.price.toFixed(2)}`),
                          React.createElement('span', {}, `${progress.toFixed(0)}% funded`)
                        ),
                        React.createElement('div', { className: "w-full bg-gray-200 rounded-full h-2" },
                          React.createElement('div', {
                            className: `h-2 rounded-full transition-all duration-300 ${
                              isFullyFunded ? 'bg-green-500' : 'bg-rose-500'
                            }`,
                            style: { width: `${progress}%` }
                          })
                        )
                      ),

                      // Contributors section - show if there are ANY contributions (confirmed OR pending)
                      item.contributions.length > 0 && React.createElement('div', { className: "mb-4" },
                        React.createElement('p', { className: "text-sm text-gray-600 mb-2" }, "Contributors:"),
                        React.createElement('div', { className: "space-y-1" },
                          ...item.contributions.map((contrib, index) => {
                            const status = contrib.status || 'confirmed'; // Default to confirmed for old contributions
                            
                            return React.createElement('div', { key: index, className: "flex justify-between items-center text-sm mb-1" },
                              React.createElement('div', { className: "flex-1" },
                                React.createElement('span', { className: "text-gray-700" }, "A generous guest"),
                                React.createElement('span', { 
                                  className: `ml-2 px-2 py-1 rounded text-xs ${
                                    status === 'confirmed' ? 'bg-green-100 text-green-800' :
                                    status === 'paid' ? 'bg-blue-100 text-blue-800' :
                                    status === 'pending_payment' ? 'bg-yellow-100 text-yellow-800' :
                                    'bg-gray-100 text-gray-800'
                                  }`
                                }, status)
                              ),
                              React.createElement('span', { className: "font-medium text-green-600" }, `¬£${contrib.amount.toFixed(2)}`)
                            );
                          })
                        )
                      ),

                      // Summary section
                      React.createElement('div', { className: "flex justify-between items-center text-sm text-gray-600 mb-4" },
                        React.createElement('span', {}, `Contributed: ¬£${totalContributed.toFixed(2)}`),
                        React.createElement('span', {}, `Remaining: ¬£${remaining.toFixed(2)}`)
                      ),

                      // Action buttons section
                      React.createElement('div', { className: "flex space-x-2" },
                        !isFullyFunded && React.createElement('button', {
                          onClick: () => openContributionModal(item),
                          className: "flex-1 bg-rose-500 text-white py-2 px-4 rounded-md hover:bg-rose-600 transition-colors font-medium"
                        }, "üéÅ Contribute"),
                        React.createElement('a', {
                          href: item.url,
                          target: "_blank",
                          rel: "noopener noreferrer",
                          className: `${isFullyFunded ? 'flex-1' : 'flex-shrink-0'} bg-gray-100 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-200 transition-colors font-medium text-center block`
                        }, `üîó ${isFullyFunded ? 'View Item' : 'URL'}`)
                      )
                    )
                  );
                })
              ),

              // Footer
              React.createElement('div', { className: "text-center mt-12 p-6 bg-white rounded-lg shadow-lg" },
                React.createElement('p', { className: "text-gray-600 mb-2" }, 
                  "Your generosity means everything to us! If you have any questions, please don't hesitate to reach out."
                ),
                React.createElement('p', { className: "text-rose-600 font-medium" }, "With love, Clara & Ross ‚ù§Ô∏è")
              )
            )
          );

          // Add modal and admin panel if needed
          const elements = [mainContent];

          // Contribution Modal
          if (showContributionModal && selectedItem) {
            elements.push(
              React.createElement('div', {
                key: "modal",
                className: "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50"
              },
                React.createElement('div', { className: "bg-white rounded-lg p-6 w-full max-w-md" },
                  React.createElement('h3', { className: "text-xl font-semibold mb-4" }, `Contribute to: ${selectedItem.item}`),
                  
                  React.createElement('div', { className: "mb-4" },
                    React.createElement('p', { className: "text-sm text-gray-600 mb-2" }, `Remaining amount needed: ¬£${getRemainingToPledge(selectedItem).toFixed(2)}`),
                    React.createElement('p', { className: "text-xs text-gray-500" }, "Payment options: PayPal or Bank Transfer")
                  ),

                  error && React.createElement('div', { className: "mb-4 p-3 bg-red-100 border border-red-300 rounded-md" },
                    React.createElement('p', { className: "text-red-800 text-sm" }, error)
                  ),

                  React.createElement('div', { className: "mb-4" },
                    React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-2" }, "Your Name"),
                    React.createElement('input', {
                      type: "text",
                      value: guestName,
                      onChange: (e) => setGuestName(e.target.value),
                      className: "w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-rose-500",
                      placeholder: "Enter your name",
                      disabled: saving
                    })
                  ),

                  React.createElement('div', { className: "mb-6" },
                    React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-2" }, "Contribution Amount"),
                    React.createElement('input', {
                      type: "number",
                      value: contributionAmount,
                      onChange: (e) => setContributionAmount(e.target.value),
                      className: "w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-rose-500",
                      placeholder: "0.00",
                      min: "1",
                      max: getRemainingToPledge(selectedItem),
                      step: "0.01",
                      disabled: saving
                    })
                  ),

                  React.createElement('div', { className: "flex space-x-3" },
                    React.createElement('button', {
                      onClick: () => setShowContributionModal(false),
                      className: "flex-1 bg-gray-200 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-300 transition-colors",
                      disabled: saving
                    }, "Cancel"),
                    React.createElement('button', {
                      onClick: handleContribution,
                      disabled: !guestName || !contributionAmount || parseFloat(contributionAmount) <= 0 || saving,
                      className: "flex-1 bg-rose-500 text-white py-2 px-4 rounded-md hover:bg-rose-600 transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed"
                    }, saving ? "‚è≥ Saving..." : "Choose Payment Method")
                  )
                )
              )
            );
          }

          // Enhanced Admin Panel
          if (showAdminPanel) {
            const adminContent = [];
            
            adminContent.push(
              React.createElement('div', { key: "admin-header", className: "flex justify-between items-center mb-4" },
                React.createElement('h3', { className: "text-xl font-semibold text-red-800" }, "üîí Admin: Payment Management"),
                React.createElement('div', { className: "flex space-x-2" },
                  React.createElement('button', {
                    onClick: loadDataFromFirebase,
                    className: "text-blue-600 hover:text-blue-800 text-sm px-3 py-1 bg-blue-100 rounded",
                    disabled: loading
                  }, loading ? "‚è≥" : "üîÑ Refresh"),
                  React.createElement('button', {
                    onClick: () => {
                      console.log('=== DEBUG: All contributions ===');
                      items.forEach(item => {
                        if (item.contributions.length > 0) {
                          console.log(`Item: ${item.item}`);
                          item.contributions.forEach(contrib => {
                            console.log('  Contribution:', {
                              id: contrib.id,
                              name: contrib.name,
                              amount: contrib.amount,
                              status: contrib.status,
                              hasStatus: contrib.hasOwnProperty('status'),
                              allKeys: Object.keys(contrib)
                            });
                          });
                        }
                      });
                    },
                    className: "text-xs bg-purple-500 text-white px-2 py-1 rounded hover:bg-purple-600"
                  }, "Debug Data"),
                  React.createElement('button', {
                    onClick: () => setShowAdminPanel(false),
                    className: "text-red-600 hover:text-red-800"
                  }, "‚úï Close")
                )
              )
            );

            adminContent.push(
              React.createElement('div', { key: "admin-info", className: "text-sm text-red-600 mb-4" }, 
                `Press Ctrl+Shift+A to toggle this panel | Firebase: ${window.firebaseDB ? '‚úÖ Connected' : '‚ùå Not configured'}`
              )
            );

            // Payment status summary
            const allContributions = items.flatMap(item => item.contributions);
            const statusCounts = allContributions.reduce((acc, contrib) => {
              const status = contrib.status || 'confirmed';
              acc[status] = (acc[status] || 0) + 1;
              return acc;
            }, {});

            adminContent.push(
              React.createElement('div', { key: "status-summary", className: "mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg" },
                React.createElement('h4', { className: "font-medium text-blue-800 mb-3" }, "Payment Status Summary"),
                React.createElement('div', { className: "grid grid-cols-3 gap-4 text-sm" },
                  Object.entries(statusCounts).map(([status, count]) => 
                    React.createElement('div', { key: status, className: "text-center" },
                      React.createElement('div', { 
                        className: `text-2xl font-bold ${
                          status === 'confirmed' ? 'text-green-600' :
                          status === 'paid' ? 'text-blue-600' :
                          status === 'pending_payment' ? 'text-yellow-600' :
                          'text-gray-600'
                        }`
                      }, count),
                      React.createElement('div', { className: "text-gray-600 capitalize" }, status.replace('_', ' '))
                    )
                  )
                )
              )
            );

            const itemsWithContributions = items.filter(item => item.contributions.length > 0);
            if (itemsWithContributions.length === 0) {
              adminContent.push(
                React.createElement('p', { key: "no-contributions", className: "text-gray-600 italic" }, "No contributions yet")
              );
            } else {
              itemsWithContributions.forEach(item => {
                adminContent.push(
                  React.createElement('div', { key: `item-${item.id}`, className: "mb-6 p-4 bg-white border rounded-lg" },
                    React.createElement('h4', { className: "font-medium text-gray-800 mb-3" }, item.item),
                    React.createElement('div', { className: "space-y-3" },
                      ...item.contributions.map((contrib, index) => {
                        const status = contrib.status || 'confirmed';
                        const isPending = status === 'pending_payment';
                        
                        return React.createElement('div', { key: index, className: "flex justify-between items-center p-3 bg-gray-50 rounded border" },
                          React.createElement('div', { className: "flex-1" },
                            React.createElement('div', { className: "flex items-center space-x-3 mb-1" },
                              React.createElement('span', { className: "font-medium text-gray-800" }, contrib.name),
                              React.createElement('span', { 
                                className: `px-2 py-1 rounded text-xs font-medium ${
                                  status === 'confirmed' ? 'bg-green-100 text-green-800' :
                                  status === 'paid' ? 'bg-blue-100 text-blue-800' :
                                  status === 'pending_payment' ? 'bg-yellow-100 text-yellow-800' :
                                  'bg-gray-100 text-gray-800'
                                }`
                              }, status.replace('_', ' ').toUpperCase())
                            ),
                            React.createElement('div', { className: "text-sm text-gray-600" },
                              `ID: ${contrib.id || 'none'} | Amount: ¬£${contrib.amount.toFixed(2)}`,
                              contrib.paymentMethod && React.createElement('span', {}, ` | Method: ${contrib.paymentMethod === 'paypal' ? 'PayPal' : 'Bank Transfer'}`),
                              contrib.timestamp && React.createElement('span', {}, ` | ${new Date(contrib.timestamp).toLocaleDateString()}`)
                            )
                          ),
                          React.createElement('div', { className: "flex space-x-2" },
                            isPending && React.createElement('button', {
                              onClick: async () => {
                                if (confirm(`Mark ${contrib.name}'s payment as confirmed?`)) {
                                  try {
                                    if (!contrib.id) {
                                      alert('Error: Contribution ID missing. Cannot confirm payment.');
                                      return;
                                    }
                                    
                                    console.log('Admin confirming payment for:', { name: contrib.name, id: contrib.id });
                                    await updatePaymentStatus(contrib.id, 'confirmed');
                                    console.log('Admin payment confirmation successful for', contrib.name);
                                    
                                  } catch (error) {
                                    console.error('Admin error confirming payment:', error);
                                    alert(`Error confirming payment for ${contrib.name}: ${error.message}`);
                                  }
                                }
                              },
                              className: "text-xs bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600 font-medium"
                            }, "‚úì Confirm Payment"),
                            status === 'confirmed' && React.createElement('button', {
                              onClick: async () => {
                                if (confirm(`Mark ${contrib.name}'s payment as pending?`)) {
                                  try {
                                    if (!contrib.id) {
                                      alert('Error: Contribution ID missing. Cannot update status.');
                                      return;
                                    }
                                    
                                    console.log('Admin marking payment as pending for:', { name: contrib.name, id: contrib.id });
                                    await updatePaymentStatus(contrib.id, 'pending_payment');
                                    console.log('Admin payment status update successful for', contrib.name);
                                    
                                  } catch (error) {
                                    console.error('Admin error updating payment status:', error);
                                    alert(`Error updating payment status for ${contrib.name}: ${error.message}`);
                                  }
                                }
                              },
                              className: "text-xs bg-yellow-500 text-white px-3 py-1 rounded hover:bg-yellow-600 font-medium"
                            }, "‚è≥ Mark Pending"),
                            React.createElement('button', {
                              onClick: async () => {
                                if (confirm(`Delete ${contrib.name}'s contribution? This cannot be undone.`)) {
                                  try {
                                    if (!contrib.id) {
                                      alert('Error: Contribution ID missing. Cannot delete.');
                                      return;
                                    }
                                    
                                    console.log('Admin deleting contribution for:', { name: contrib.name, id: contrib.id });
                                    const contributionRef = window.firebaseDB.ref(`contributions/${contrib.id}`);
                                    await contributionRef.remove();
                                    console.log('Admin contribution deletion successful for', contrib.name);
                                    
                                  } catch (error) {
                                    console.error('Admin error deleting contribution:', error);
                                    alert(`Error deleting contribution for ${contrib.name}: ${error.message}`);
                                  }
                                }
                              },
                              className: "text-xs bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 font-medium"
                            }, "üóëÔ∏è Delete")
                          )
                        );
                      })
                    ),
                    React.createElement('div', { className: "mt-3 pt-3 border-t text-sm font-medium" }, 
                      `Total for this item: ¬£${getTotalContributed(item).toFixed(2)} (${item.contributions.length} contributions)`
                    )
                  )
                );
              });

              adminContent.push(
                React.createElement('div', { key: "summary", className: "mt-6 p-4 bg-green-50 border border-green-200 rounded-lg" },
                  React.createElement('h4', { className: "font-medium text-green-800 mb-2" }, "Summary"),
                  React.createElement('div', { className: "text-sm space-y-1" },
                    React.createElement('p', {}, `Total contributions: ¬£${items.reduce((total, item) => total + getTotalContributed(item), 0).toFixed(2)}`),
                    React.createElement('p', {}, `Total pending: ¬£${allContributions.filter(c => c.status === 'pending_payment').reduce((sum, c) => sum + c.amount, 0).toFixed(2)}`),
                    React.createElement('p', {}, `Number of contributors: ${allContributions.length}`),
                    React.createElement('p', {}, `Items with contributions: ${itemsWithContributions.length}`)
                  )
                )
              );
            }

            elements.push(
              React.createElement('div', {
                key: "admin",
                className: "bg-red-50 border-2 border-red-200 rounded-lg p-6 mt-8"
              }, ...adminContent)
            );
          }

          return React.createElement(React.Fragment, {}, ...elements);
        }

        ReactDOM.render(React.createElement(WeddingGiftRegistry), document.getElementById('root'));
    </script>
</body>
</html>
