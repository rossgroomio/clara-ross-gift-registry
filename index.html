<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clara & Ross's Wedding Registry</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body>
    <div id="root"></div>
    
    <script>
        // Replace with your Firebase config
        const firebaseConfig = {
          apiKey: "AIzaSyCSkzRczHX9dLjd7ZPk31NfuaQeD7sy_kk",
          authDomain: "clara-ross-gift-registry.firebaseapp.com",
          projectId: "clara-ross-gift-registry",
          storageBucket: "clara-ross-gift-registry.firebasestorage.app",
          messagingSenderId: "75526395782",
          appId: "1:75526395782:web:63cea957ced9f951effe07"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        window.firebaseDB = firebase.database();
    </script>
    
    <script>
        const { useState, useEffect } = React;
        const { createElement: e } = React;

        const WeddingGiftRegistry = () => {
          const [items, setItems] = useState([]);
          const [filter, setFilter] = useState('all');
          const [guestName, setGuestName] = useState('');
          const [showContributionModal, setShowContributionModal] = useState(false);
          const [selectedItem, setSelectedItem] = useState(null);
          const [contributionAmount, setContributionAmount] = useState('');
          const [showAdminPanel, setShowAdminPanel] = useState(false);
          const [loading, setLoading] = useState(true);
          const [saving, setSaving] = useState(false);
          const [error, setError] = useState(null);

          // Clara & Ross's Wedding Gift List
          const giftItems = [
            { id: 1, item: "Outdoor cushion storage box", price: 249.99, url: "https://www.tatesofsussex.co.uk/shop/products/outdoor-living/garden-storage/storage-boxes/storage-box-570-litre.html" },
            { id: 2, item: "Pendant light", price: 250.00, url: "https://www.nkuku.com/products/chakai-wood-metal-pendant-large-cp05" },
            { id: 3, item: "Bedside lamp #1", price: 40.00, url: "https://www.johnlewis.com/john-lewis-isabel-mini-touch-table-lamp/antique-brass/p6092035" },
            { id: 4, item: "Bedside lamp #2", price: 40.00, url: "https://www.johnlewis.com/john-lewis-isabel-mini-touch-table-lamp/antique-brass/p6092035" },
            { id: 5, item: "Living room side table [50cm]", price: 150.00, url: "https://theindustrialfurniture.co.uk/products/mushroom-wooden-round-coffee-table-wood-end-table-side-table-solid-wood-coffee-table-40cm-50cm-60cm?srsltid=AfmBOoqfsLsXgEgcKFa-wa9iXCFdCxfPHwct0dxVv3h9rvJyvdckLa_X&variant=43090121130172" },
            { id: 6, item: "Rug (152 x 244cm)", price: 498.00, url: "https://www.anthropologie.com/en-gb/shop/hybrid/matilda-goad-co-tufted-plaid-rug?color=048&size=152cm+x+244cm&type=REGULAR&inventoryCountry=GB&countryCode=GB&currency=GBP&epik=dj0yJnU9Q1JMSUNYUXpDcjh2NW9aTTFfU19MUW9oZVRwWW51dVQmcD0wJm49OXAwZm55Nnc0NmdkdVJ2d3ZkWHFTZyZ0PUFBQUFBR2hxS2tV&quantity=1" },
            { id: 7, item: "Window seat cushion - Honey Pot Clever Velvet (30x60cm) #1", price: 69.00, url: "https://loaf.com/products/scatter-cushions?colour=honey-pot-clever-velvet&size=30-x-60-cm" },
            { id: 8, item: "Window seat cushion - Honey Pot Clever Velvet (30x60cm) #2", price: 69.00, url: "https://loaf.com/products/scatter-cushions?colour=honey-pot-clever-velvet&size=30-x-60-cm" },
            { id: 9, item: "Window seat cushion - Honey Pot Clever Velvet (30x60cm) #3", price: 69.00, url: "https://loaf.com/products/scatter-cushions?colour=honey-pot-clever-velvet&size=30-x-60-cm" },
            { id: 10, item: "Window seat cushion - Honey Pot Clever Velvet (30x60cm) #4", price: 69.00, url: "https://loaf.com/products/scatter-cushions?colour=honey-pot-clever-velvet&size=30-x-60-cm" },
            { id: 11, item: "Window seat cushion - Honey Pot Clever Velvet (30x60cm) #5", price: 69.00, url: "https://loaf.com/products/scatter-cushions?colour=honey-pot-clever-velvet&size=30-x-60-cm" }
          ];

          // Initialize Firebase connection
          useEffect(() => {
            loadDataFromFirebase();
            
            // Set up real-time listener if Firebase is configured
            if (window.firebaseDB) {
              const contributionsRef = window.firebaseDB.ref('contributions');
              const listener = contributionsRef.on('value', (snapshot) => {
                loadDataFromFirebase();
              });
              
              return () => contributionsRef.off('value', listener);
            }
          }, []);

          const loadDataFromFirebase = async () => {
            setLoading(true);
            setError(null);

            try {
              if (!window.firebaseDB) {
                throw new Error('Firebase not configured');
              }

              const contributionsRef = window.firebaseDB.ref('contributions');
              const snapshot = await contributionsRef.once('value');
              const contributionsData = snapshot.val() || {};
              
              // Convert Firebase object to array
              const contributions = Object.keys(contributionsData).map(key => ({
                id: key,
                ...contributionsData[key]
              }));

              // Merge contributions with items
              const itemsWithContributions = giftItems.map(item => {
                const itemContributions = contributions.filter(contrib => contrib.itemId === item.id);
                const totalContributed = itemContributions.reduce((sum, contrib) => sum + contrib.amount, 0);
                return {
                  ...item,
                  contributions: itemContributions,
                  purchased: totalContributed >= item.price
                };
              });

              setItems(itemsWithContributions);
            } catch (err) {
              console.error('Error loading from Firebase:', err);
              setError('Firebase not configured - running in demo mode');
              
              // Fallback to local data
              const itemsWithContributions = giftItems.map(item => ({
                ...item,
                contributions: [],
                purchased: false
              }));
              setItems(itemsWithContributions);
            } finally {
              setLoading(false);
            }
          };

          const saveContributionToFirebase = async (itemId, name, amount) => {
            try {
              if (!window.firebaseDB) {
                throw new Error('Firebase not configured');
              }

              const contribution = {
                itemId,
                name,
                amount,
                timestamp: new Date().toISOString()
              };

              const contributionsRef = window.firebaseDB.ref('contributions');
              await contributionsRef.push(contribution);
              
              console.log('Contribution saved to Firebase:', contribution);
            } catch (err) {
              console.error('Error saving to Firebase:', err);
              throw err;
            }
          };

          useEffect(() => {
            // Add keyboard shortcut to toggle admin panel (Ctrl+Shift+A)
            const handleKeyPress = (e) => {
              if (e.ctrlKey && e.shiftKey && e.key === 'A') {
                setShowAdminPanel(!showAdminPanel);
              }
            };
            
            window.addEventListener('keydown', handleKeyPress);
            return () => window.removeEventListener('keydown', handleKeyPress);
          }, [showAdminPanel]);

          const getTotalContributed = (item) => {
            return item.contributions.reduce((sum, contrib) => sum + contrib.amount, 0);
          };

          const getRemainingAmount = (item) => {
            return Math.max(0, item.price - getTotalContributed(item));
          };

          const getProgressPercentage = (item) => {
            return Math.min(100, (getTotalContributed(item) / item.price) * 100);
          };

          const filteredItems = items.filter(item => {
            if (filter === 'available') return !item.purchased && getRemainingAmount(item) > 0;
            if (filter === 'purchased') return item.purchased || getRemainingAmount(item) === 0;
            return true;
          });

          const handleContribution = async () => {
            if (!guestName || !contributionAmount || !selectedItem) return;

            const amount = parseFloat(contributionAmount);
            const remaining = getRemainingAmount(selectedItem);
            const actualAmount = Math.min(amount, remaining);

            setSaving(true);
            setError(null);

            try {
              await saveContributionToFirebase(selectedItem.id, guestName, actualAmount);
              
              setShowContributionModal(false);
              setGuestName('');
              setContributionAmount('');
              setSelectedItem(null);
              
              // Data will auto-refresh via the real-time listener
            } catch (err) {
              setError('Failed to save contribution. Please try again.');
              console.error('Contribution error:', err);
            } finally {
              setSaving(false);
            }
          };

          const openContributionModal = (item) => {
            setSelectedItem(item);
            setShowContributionModal(true);
          };

          if (loading) {
            return e('div', {
              className: "min-h-screen bg-gradient-to-br from-rose-50 to-pink-100 flex items-center justify-center"
            }, 
              e('div', { className: "text-center" }, [
                e('div', {
                  key: "loader",
                  className: "w-8 h-8 border-4 border-rose-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"
                }),
                e('p', { key: "text", className: "text-gray-600" }, "Loading wedding registry...")
              ])
            );
          }

          return e('div', {
            className: "min-h-screen bg-gradient-to-br from-rose-50 to-pink-100 p-4"
          }, 
            e('div', { className: "max-w-6xl mx-auto" }, [
              // Header
              e('div', {
                key: "header",
                className: "text-center mb-8 bg-white rounded-lg shadow-lg p-8"
              }, [
                e('div', { key: "heart", className: "flex justify-center mb-4" }, 
                  e('div', { className: "text-4xl" }, "‚ù§Ô∏è")
                ),
                e('h1', { key: "title", className: "text-4xl font-bold text-gray-800 mb-2" }, "Clara & Ross's"),
                e('h2', { key: "subtitle", className: "text-2xl text-rose-600 mb-4" }, "Wedding Gift Registry"),
                e('p', { key: "description", className: "text-gray-600 max-w-2xl mx-auto" }, 
                  "Thank you for celebrating our special day with us! Your love and support mean the world to us. You can contribute any amount toward the gifts below or purchase items directly."
                ),
                error && e('div', {
                  key: "error",
                  className: "mt-4 p-3 bg-yellow-100 border border-yellow-300 rounded-md"
                }, [
                  e('p', { key: "error-text", className: "text-yellow-800 text-sm" }, error),
                  e('button', {
                    key: "refresh-btn",
                    onClick: loadDataFromFirebase,
                    className: "mt-2 text-yellow-800 underline text-sm hover:no-underline"
                  }, "Try refreshing")
                ])
              ]),

              // Connection Status
              e('div', { key: "status", className: "text-center mb-4" },
                e('div', { className: "inline-flex items-center space-x-2 text-sm" }, [
                  e('div', {
                    key: "indicator",
                    className: `w-2 h-2 rounded-full ${window.firebaseDB ? 'bg-green-500' : 'bg-yellow-500'}`
                  }),
                  e('span', { key: "text", className: "text-gray-600" }, 
                    window.firebaseDB ? 'Connected to Firebase' : 'Demo mode - Firebase not configured'
                  )
                ])
              ),

              // Filter Buttons
              e('div', { key: "filters", className: "flex justify-center mb-6 space-x-4" }, [
                e('button', {
                  key: "all",
                  onClick: () => setFilter('all'),
                  className: `px-6 py-2 rounded-full font-medium transition-colors ${
                    filter === 'all' 
                      ? 'bg-rose-500 text-white' 
                      : 'bg-white text-gray-600 hover:bg-rose-100'
                  }`
                }, `All Items (${items.length})`),
                e('button', {
                  key: "available",
                  onClick: () => setFilter('available'),
                  className: `px-6 py-2 rounded-full font-medium transition-colors ${
                    filter === 'available' 
                      ? 'bg-rose-500 text-white' 
                      : 'bg-white text-gray-600 hover:bg-rose-100'
                  }`
                }, `Available (${items.filter(item => !item.purchased && getRemainingAmount(item) > 0).length})`),
                e('button', {
                  key: "purchased",
                  onClick: () => setFilter('purchased'),
                  className: `px-6 py-2 rounded-full font-medium transition-colors ${
                    filter === 'purchased' 
                      ? 'bg-rose-500 text-white' 
                      : 'bg-white text-gray-600 hover:bg-rose-100'
                  }`
                }, `Fulfilled (${items.filter(item => item.purchased || getRemainingAmount(item) === 0).length})`)
              ]),

              // Gift Items Grid
              e('div', { key: "grid", className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" },
                filteredItems.map((item) => {
                  const totalContributed = getTotalContributed(item);
                  const remaining = getRemainingAmount(item);
                  const progress = getProgressPercentage(item);
                  const isFullyFunded = remaining === 0 || item.purchased;

                  return e('div', {
                    key: item.id,
                    className: "bg-white rounded-lg shadow-lg overflow-hidden hover:shadow-xl transition-shadow"
                  },
                    e('div', { className: "p-6" }, [
                      // Item header
                      e('div', { key: "header", className: "flex justify-between items-start mb-3" }, [
                        e('h3', { key: "title", className: "text-lg font-semibold text-gray-800 leading-tight" }, item.item),
                        isFullyFunded && e('span', { key: "check", className: "text-green-500 text-xl" }, "‚úì")
                      ]),
                      
                      // Progress bar
                      e('div', { key: "progress", className: "mb-4" }, [
                        e('div', { key: "progress-text", className: "flex justify-between text-sm text-gray-600 mb-1" }, [
                          e('span', { key: "goal" }, `Goal: ¬£${item.price.toFixed(2)}`),
                          e('span', { key: "percent" }, `${progress.toFixed(0)}% funded`)
                        ]),
                        e('div', { key: "progress-bar", className: "w-full bg-gray-200 rounded-full h-2" },
                          e('div', {
                            className: `h-2 rounded-full transition-all duration-300 ${
                              isFullyFunded ? 'bg-green-500' : 'bg-rose-500'
                            }`,
                            style: { width: `${progress}%` }
                          })
                        )
                      ]),

                      // Contributors
                      totalContributed > 0 && e('div', { key: "contributors", className: "mb-4" }, [
                        e('p', { key: "contributors-title", className: "text-sm text-gray-600 mb-2" }, "Contributors:"),
                        e('div', { key: "contributors-list", className: "space-y-1" },
                          item.contributions.map((contrib, index) => 
                            e('div', { key: index, className: "flex justify-between text-sm" }, [
                              e('span', { key: "name", className: "text-gray-700" }, `Anonymous Guest ${index + 1}`),
                              e('span', { key: "amount", className: "text-rose-600 font-medium" }, `¬£${contrib.amount.toFixed(2)}`)
                            ])
                          )
                        )
                      ]),

                      // Summary
                      e('div', { key: "summary", className: "flex justify-between items-center text-sm text-gray-600 mb-4" }, [
                        e('span', { key: "contributed" }, `Contributed: ¬£${totalContributed.toFixed(2)}`),
                        e('span', { key: "remaining" }, `Remaining: ¬£${remaining.toFixed(2)}`)
                      ]),

                      // Action buttons
                      e('div', { key: "actions", className: "flex space-x-2" }, [
                        !isFullyFunded && e('button', {
                          key: "contribute",
                          onClick: () => openContributionModal(item),
                          className: "flex-1 bg-rose-500 text-white py-2 px-4 rounded-md hover:bg-rose-600 transition-colors font-medium"
                        }, "üéÅ Contribute"),
                        e('a', {
                          key: "buy",
                          href: item.url,
                          target: "_blank",
                          rel: "noopener noreferrer",
                          className: `${isFullyFunded ? 'flex-1' : 'flex-shrink-0'} bg-gray-100 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-200 transition-colors font-medium text-center`
                        }, `üîó ${isFullyFunded ? 'View Item' : 'Buy Direct'}`)
                      ])
                    ])
                  );
                })
              ),

              // Contribution Modal
              showContributionModal && selectedItem && e('div', {
                key: "modal",
                className: "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50"
              },
                e('div', { className: "bg-white rounded-lg p-6 w-full max-w-md" }, [
                  e('h3', { key: "modal-title", className: "text-xl font-semibold mb-4" }, `Contribute to: ${selectedItem.item}`),
                  
                  e('div', { key: "modal-remaining", className: "mb-4" },
                    e('p', { className: "text-sm text-gray-600 mb-2" }, `Remaining amount needed: ¬£${getRemainingAmount(selectedItem).toFixed(2)}`)
                  ),

                  error && e('div', { key: "modal-error", className: "mb-4 p-3 bg-red-100 border border-red-300 rounded-md" },
                    e('p', { className: "text-red-800 text-sm" }, error)
                  ),

                  e('div', { key: "modal-name", className: "mb-4" }, [
                    e('label', { key: "name-label", className: "block text-sm font-medium text-gray-700 mb-2" }, "Your Name"),
                    e('input', {
                      key: "name-input",
                      type: "text",
                      value: guestName,
                      onChange: (e) => setGuestName(e.target.value),
                      className: "w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-rose-500",
                      placeholder: "Enter your name",
                      disabled: saving
                    })
                  ]),

                  e('div', { key: "modal-amount", className: "mb-6" }, [
                    e('label', { key: "amount-label", className: "block text-sm font-medium text-gray-700 mb-2" }, "Contribution Amount"),
                    e('input', {
                      key: "amount-input",
                      type: "number",
                      value: contributionAmount,
                      onChange: (e) => setContributionAmount(e.target.value),
                      className: "w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-rose-500",
                      placeholder: "0.00",
                      min: "1",
                      max: getRemainingAmount(selectedItem),
                      step: "0.01",
                      disabled: saving
                    })
                  ]),

                  e('div', { key: "modal-buttons", className: "flex space-x-3" }, [
                    e('button', {
                      key: "cancel",
                      onClick: () => setShowContributionModal(false),
                      className: "flex-1 bg-gray-200 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-300 transition-colors",
                      disabled: saving
                    }, "Cancel"),
                    e('button', {
                      key: "contribute",
                      onClick: handleContribution,
                      disabled: !guestName || !contributionAmount || parseFloat(contributionAmount) <= 0 || saving,
                      className: "flex-1 bg-rose-500 text-white py-2 px-4 rounded-md hover:bg-rose-600 transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed"
                    }, saving ? "‚è≥ Saving..." : "Contribute")
                  ])
                ])
              ),

              // Admin Panel
              showAdminPanel && e('div', {
                key: "admin",
                className: "bg-red-50 border-2 border-red-200 rounded-lg p-6 mt-8"
              }, [
                e('div', { key: "admin-header", className: "flex justify-between items-center mb-4" }, [
                  e('h3', { key: "title", className: "text-xl font-semibold text-red-800" }, "üîí Admin: Contributor Details"),
                  e('div', { key: "admin-controls", className: "flex space-x-2" }, [
                    e('button', {
                      key: "refresh",
                      onClick: loadDataFromFirebase,
                      className: "text-blue-600 hover:text-blue-800 text-sm px-3 py-1 bg-blue-100 rounded",
                      disabled: loading
                    }, loading ? "‚è≥" : "üîÑ Refresh"),
                    e('button', {
                      key: "close",
                      onClick: () => setShowAdminPanel(false),
                      className: "text-red-600 hover:text-red-800"
                    }, "‚úï Close")
                  ])
                ]),
                e('div', { key: "admin-info", className: "text-sm text-red-600 mb-4" }, 
                  `Press Ctrl+Shift+A to toggle this panel | Firebase: ${window.firebaseDB ? '‚úÖ Connected' : '‚ùå Not configured'}`
                ),
                items.filter(item => item.contributions.length > 0).length === 0 ? 
                  e('p', { key: "no-contributions", className: "text-gray-600 italic" }, "No contributions yet") :
                  [
                    ...items.filter(item => item.contributions.length > 0).map(item => 
                      e('div', { key: item.id, className: "mb-4 p-4 bg-white border rounded" }, [
                        e('h4', { key: "item-title", className: "font-medium text-gray-800 mb-2" }, item.item),
                        e('div', { key: "contributors", className: "space-y-1" },
                          item.contributions.map((contrib, index) => 
                            e('div', { key: index, className: "flex justify-between text-sm" }, [
                              e('span', { key: "name", className: "text-gray-700" }, contrib.name),
                              e('span', { key: "amount", className: "font-medium text-green-600" }, `¬£${contrib.amount.toFixed(2)}`)
                            ])
                          )
                        ),
                        e('div', { key: "total", className: "mt-2 pt-2 border-t text-sm font-medium" }, 
                          `Total for this item: ¬£${getTotalContributed(item).toFixed(2)}`
                        )
                      ])
                    ),
                    items.filter(item => item.contributions.length > 0).length > 0 && e('div', {
                      key: "summary",
                      className: "mt-6 p-4 bg-green-50 border border-green-200 rounded"
                    }, [
                      e('h4', { key: "summary-title", className: "font-medium text-green-800 mb-2" }, "Summary"),
                      e('div', { key: "summary-stats", className: "text-sm" }, [
                        e('p', { key: "total-contrib" }, `Total contributions: ¬£${items.reduce((total, item) => total + getTotalContributed(item), 0).toFixed(2)}`),
                        e('p', { key: "num-contrib" }, `Number of contributors: ${items.reduce((total, item) => total + item.contributions.length, 0)}`),
                        e('p', { key: "items-contrib" }, `Items with contributions: ${items.filter(item => item.contributions.length > 0).length}`)
                      ])
                    ])
                  ]
              ),

              // Footer
              e('div', { key: "footer", className: "text-center mt-12 p-6 bg-white rounded-lg shadow-lg" }, [
                e('p', { key: "message", className: "text-gray-600 mb-2" }, 
                  "Your generosity means everything to us! If you have any questions, please don't hesitate to reach out."
                ),
                e('p', { key: "signature", className: "text-rose-600 font-medium" }, "With love, Clara & Ross ‚ù§Ô∏è")
              ])
            ])
          );
        };

        ReactDOM.render(React.createElement(WeddingGiftRegistry), document.getElementById('root'));
    </script>
</body>
</html>
