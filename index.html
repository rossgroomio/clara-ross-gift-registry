<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clara & Ross's Wedding Registry</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body>
    <div id="root"></div>
    
    <script>
        // Replace with your Firebase config
        const firebaseConfig = {
          apiKey: "AIzaSyCSkzRczHX9dLjd7ZPk31NfuaQeD7sy_kk",
          authDomain: "clara-ross-gift-registry.firebaseapp.com",
          projectId: "clara-ross-gift-registry",
          storageBucket: "clara-ross-gift-registry.firebasestorage.app",
          messagingSenderId: "75526395782",
          appId: "1:75526395782:web:63cea957ced9f951effe07"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        window.firebaseDB = firebase.database();
    </script>
    
    <script type="text/babel">
        const { useState, useEffect } = React;

        const WeddingGiftRegistry = () => {
          const [items, setItems] = useState([]);
          const [filter, setFilter] = useState('all');
          const [guestName, setGuestName] = useState('');
          const [showContributionModal, setShowContributionModal] = useState(false);
          const [selectedItem, setSelectedItem] = useState(null);
          const [contributionAmount, setContributionAmount] = useState('');
          const [showAdminPanel, setShowAdminPanel] = useState(false);
          const [loading, setLoading] = useState(true);
          const [saving, setSaving] = useState(false);
          const [error, setError] = useState(null);

          // Clara & Ross's Wedding Gift List
          const giftItems = [
            { id: 1, item: "Outdoor cushion storage box", price: 249.99, url: "https://www.tatesofsussex.co.uk/shop/products/outdoor-living/garden-storage/storage-boxes/storage-box-570-litre.html" },
            { id: 2, item: "Pendant light", price: 250.00, url: "https://www.nkuku.com/products/chakai-wood-metal-pendant-large-cp05" },
            { id: 3, item: "Bedside lamp #1", price: 40.00, url: "https://www.johnlewis.com/john-lewis-isabel-mini-touch-table-lamp/antique-brass/p6092035" },
            { id: 4, item: "Bedside lamp #2", price: 40.00, url: "https://www.johnlewis.com/john-lewis-isabel-mini-touch-table-lamp/antique-brass/p6092035" },
            { id: 5, item: "Living room side table [50cm]", price: 150.00, url: "https://theindustrialfurniture.co.uk/products/mushroom-wooden-round-coffee-table-wood-end-table-side-table-solid-wood-coffee-table-40cm-50cm-60cm?srsltid=AfmBOoqfsLsXgEgcKFa-wa9iXCFdCxfPHwct0dxVv3h9rvJyvdckLa_X&variant=43090121130172" },
            { id: 6, item: "Rug (152 x 244cm)", price: 498.00, url: "https://www.anthropologie.com/en-gb/shop/hybrid/matilda-goad-co-tufted-plaid-rug?color=048&size=152cm+x+244cm&type=REGULAR&inventoryCountry=GB&countryCode=GB&currency=GBP&epik=dj0yJnU9Q1JMSUNYUXpDcjh2NW9aTTFfU19MUW9oZVRwWW51dVQmcD0wJm49OXAwZm55Nnc0NmdkdVJ2d3ZkWHFTZyZ0PUFBQUFBR2hxS2tV&quantity=1" },
            { id: 7, item: "Window seat cushion - Honey Pot Clever Velvet (30x60cm) #1", price: 69.00, url: "https://loaf.com/products/scatter-cushions?colour=honey-pot-clever-velvet&size=30-x-60-cm" },
            { id: 8, item: "Window seat cushion - Honey Pot Clever Velvet (30x60cm) #2", price: 69.00, url: "https://loaf.com/products/scatter-cushions?colour=honey-pot-clever-velvet&size=30-x-60-cm" },
            { id: 9, item: "Window seat cushion - Honey Pot Clever Velvet (30x60cm) #3", price: 69.00, url: "https://loaf.com/products/scatter-cushions?colour=honey-pot-clever-velvet&size=30-x-60-cm" },
            { id: 10, item: "Window seat cushion - Honey Pot Clever Velvet (30x60cm) #4", price: 69.00, url: "https://loaf.com/products/scatter-cushions?colour=honey-pot-clever-velvet&size=30-x-60-cm" },
            { id: 11, item: "Window seat cushion - Honey Pot Clever Velvet (30x60cm) #5", price: 69.00, url: "https://loaf.com/products/scatter-cushions?colour=honey-pot-clever-velvet&size=30-x-60-cm" }
          ];

          // Initialize Firebase connection
          useEffect(() => {
            loadDataFromFirebase();
            
            // Set up real-time listener if Firebase is configured
            if (window.firebaseDB) {
              const contributionsRef = window.firebaseDB.ref('contributions');
              const listener = contributionsRef.on('value', (snapshot) => {
                loadDataFromFirebase();
              });
              
              return () => contributionsRef.off('value', listener);
            }
          }, []);

          const loadDataFromFirebase = async () => {
            setLoading(true);
            setError(null);

            try {
              if (!window.firebaseDB) {
                throw new Error('Firebase not configured');
              }

              const contributionsRef = window.firebaseDB.ref('contributions');
              const snapshot = await contributionsRef.once('value');
              const contributionsData = snapshot.val() || {};
              
              // Convert Firebase object to array
              const contributions = Object.keys(contributionsData).map(key => ({
                id: key,
                ...contributionsData[key]
              }));

              // Merge contributions with items
              const itemsWithContributions = giftItems.map(item => {
                const itemContributions = contributions.filter(contrib => contrib.itemId === item.id);
                const totalContributed = itemContributions.reduce((sum, contrib) => sum + contrib.amount, 0);
                return {
                  ...item,
                  contributions: itemContributions,
                  purchased: totalContributed >= item.price
                };
              });

              setItems(itemsWithContributions);
            } catch (err) {
              console.error('Error loading from Firebase:', err);
              setError('Firebase not configured - running in demo mode');
              
              // Fallback to local data
              const itemsWithContributions = giftItems.map(item => ({
                ...item,
                contributions: [],
                purchased: false
              }));
              setItems(itemsWithContributions);
            } finally {
              setLoading(false);
            }
          };

          const saveContributionToFirebase = async (itemId, name, amount) => {
            try {
              if (!window.firebaseDB) {
                throw new Error('Firebase not configured');
              }

              const contribution = {
                itemId,
                name,
                amount,
                timestamp: new Date().toISOString()
              };

              const contributionsRef = window.firebaseDB.ref('contributions');
              await contributionsRef.push(contribution);
              
              console.log('Contribution saved to Firebase:', contribution);
            } catch (err) {
              console.error('Error saving to Firebase:', err);
              throw err;
            }
          };

          useEffect(() => {
            // Add keyboard shortcut to toggle admin panel (Ctrl+Shift+A)
            const handleKeyPress = (e) => {
              if (e.ctrlKey && e.shiftKey && e.key === 'A') {
                setShowAdminPanel(!showAdminPanel);
              }
            };
            
            window.addEventListener('keydown', handleKeyPress);
            return () => window.removeEventListener('keydown', handleKeyPress);
          }, [showAdminPanel]);

          const getTotalContributed = (item) => {
            return item.contributions.reduce((sum, contrib) => sum + contrib.amount, 0);
          };

          const getRemainingAmount = (item) => {
            return Math.max(0, item.price - getTotalContributed(item));
          };

          const getProgressPercentage = (item) => {
            return Math.min(100, (getTotalContributed(item) / item.price) * 100);
          };

          const filteredItems = items.filter(item => {
            if (filter === 'available') return !item.purchased && getRemainingAmount(item) > 0;
            if (filter === 'purchased') return item.purchased || getRemainingAmount(item) === 0;
            return true;
          });

          const handleContribution = async () => {
            if (!guestName || !contributionAmount || !selectedItem) return;

            const amount = parseFloat(contributionAmount);
            const remaining = getRemainingAmount(selectedItem);
            const actualAmount = Math.min(amount, remaining);

            setSaving(true);
            setError(null);

            try {
              await saveContributionToFirebase(selectedItem.id, guestName, actualAmount);
              
              setShowContributionModal(false);
              setGuestName('');
              setContributionAmount('');
              setSelectedItem(null);
              
              // Data will auto-refresh via the real-time listener
            } catch (err) {
              setError('Failed to save contribution. Please try again.');
              console.error('Contribution error:', err);
            } finally {
              setSaving(false);
            }
          };

          const openContributionModal = (item) => {
            setSelectedItem(item);
            setShowContributionModal(true);
          };

          if (loading) {
            return (
              <div className="min-h-screen bg-gradient-to-br from-rose-50 to-pink-100 flex items-center justify-center">
                <div className="text-center">
                  <div className="w-8 h-8 border-4 border-rose-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                  <p className="text-gray-600">Loading wedding registry...</p>
                </div>
              </div>
            );
          }

          return (
            <div className="min-h-screen bg-gradient-to-br from-rose-50 to-pink-100 p-4">
              <div className="max-w-6xl mx-auto">
                <div className="text-center mb-8 bg-white rounded-lg shadow-lg p-8">
                  <div className="flex justify-center mb-4">
                    <div className="w-12 h-12 text-rose-500">‚ù§Ô∏è</div>
                  </div>
                  <h1 className="text-4xl font-bold text-gray-800 mb-2">Clara & Ross's</h1>
                  <h2 className="text-2xl text-rose-600 mb-4">Wedding Gift Registry</h2>
                  <p className="text-gray-600 max-w-2xl mx-auto">
                    Thank you for celebrating our special day with us! Your love and support mean the world to us. 
                    You can contribute any amount toward the gifts below or purchase items directly.
                  </p>
                  {error && (
                    <div className="mt-4 p-3 bg-yellow-100 border border-yellow-300 rounded-md">
                      <p className="text-yellow-800 text-sm">{error}</p>
                      <button 
                        onClick={loadDataFromFirebase}
                        className="mt-2 text-yellow-800 underline text-sm hover:no-underline"
                      >
                        Try refreshing
                      </button>
                    </div>
                  )}
                </div>

                <div className="text-center mb-4">
                  <div className="inline-flex items-center space-x-2 text-sm">
                    <div className={`w-2 h-2 rounded-full ${window.firebaseDB ? 'bg-green-500' : 'bg-yellow-500'}`}></div>
                    <span className="text-gray-600">
                      {window.firebaseDB ? 'Connected to Firebase' : 'Demo mode - Firebase not configured'}
                    </span>
                  </div>
                </div>

                <div className="flex justify-center mb-6 space-x-4">
                  <button
                    onClick={() => setFilter('all')}
                    className={`px-6 py-2 rounded-full font-medium transition-colors ${
                      filter === 'all' 
                        ? 'bg-rose-500 text-white' 
                        : 'bg-white text-gray-600 hover:bg-rose-100'
                    }`}
                  >
                    All Items ({items.length})
                  </button>
                  <button
                    onClick={() => setFilter('available')}
                    className={`px-6 py-2 rounded-full font-medium transition-colors ${
                      filter === 'available' 
                        ? 'bg-rose-500 text-white' 
                        : 'bg-white text-gray-600 hover:bg-rose-100'
                    }`}
                  >
                    Available ({items.filter(item => !item.purchased && getRemainingAmount(item) > 0).length})
                  </button>
                  <button
                    onClick={() => setFilter('purchased')}
                    className={`px-6 py-2 rounded-full font-medium transition-colors ${
                      filter === 'purchased' 
                        ? 'bg-rose-500 text-white' 
                        : 'bg-white text-gray-600 hover:bg-rose-100'
                    }`}
                  >
                    Fulfilled ({items.filter(item => item.purchased || getRemainingAmount(item) === 0).length})
                  </button>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                  {filteredItems.map((item) => {
                    const totalContributed = getTotalContributed(item);
                    const remaining = getRemainingAmount(item);
                    const progress = getProgressPercentage(item);
                    const isFullyFunded = remaining === 0 || item.purchased;

                    return (
                      <div key={item.id} className="bg-white rounded-lg shadow-lg overflow-hidden hover:shadow-xl transition-shadow">
                        <div className="p-6">
                          <div className="flex justify-between items-start mb-3">
                            <h3 className="text-lg font-semibold text-gray-800 leading-tight">{item.item}</h3>
                            {isFullyFunded && <span className="text-green-500 text-xl">‚úì</span>}
                          </div>
                          
                          <div className="mb-4">
                            <div className="flex justify-between text-sm text-gray-600 mb-1">
                              <span>Goal: ¬£{item.price.toFixed(2)}</span>
                              <span>{progress.toFixed(0)}% funded</span>
                            </div>
                            <div className="w-full bg-gray-200 rounded-full h-2">
                              <div 
                                className={`h-2 rounded-full transition-all duration-300 ${
                                  isFullyFunded ? 'bg-green-500' : 'bg-rose-500'
                                }`}
                                style={{ width: `${progress}%` }}
                              ></div>
                            </div>
                          </div>

                          {totalContributed > 0 && (
                            <div className="mb-4">
                              <p className="text-sm text-gray-600 mb-2">Contributors:</p>
                              <div className="space-y-1">
                                {item.contributions.map((contrib, index) => (
                                  <div key={index} className="flex justify-between text-sm">
                                    <span className="text-gray-700">Anonymous Guest {index + 1}</span>
                                    <span className="text-rose-600 font-medium">¬£{contrib.amount.toFixed(2)}</span>
                                  </div>
                                ))}
                              </div>
                            </div>
                          )}

                          <div className="flex justify-between items-center text-sm text-gray-600 mb-4">
                            <span>Contributed: ¬£{totalContributed.toFixed(2)}</span>
                            <span>Remaining: ¬£{remaining.toFixed(2)}</span>
                          </div>

                          <div className="flex space-x-2">
                            {!isFullyFunded && (
                              <button
                                onClick={() => openContributionModal(item)}
                                className="flex-1 bg-rose-500 text-white py-2 px-4 rounded-md hover:bg-rose-600 transition-colors font-medium"
                              >
                                üéÅ Contribute
                              </button>
                            )}
                            
                              href={item.url}
                              target="_blank"
                              rel="noopener noreferrer"
                              className={`${isFullyFunded ? 'flex-1' : 'flex-shrink-0'} bg-gray-100 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-200 transition-colors font-medium text-center`}
                            >
                              üîó {isFullyFunded ? 'View Item' : 'Buy Direct'}
                            </a>
                          </div>
                        </div>
                      </div>
                    );
                  })}
                </div>

                {showContributionModal && selectedItem && (
                  <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-lg p-6 w-full max-w-md">
                      <h3 className="text-xl font-semibold mb-4">Contribute to: {selectedItem.item}</h3>
                      
                      <div className="mb-4">
                        <p className="text-sm text-gray-600 mb-2">Remaining amount needed: ¬£{getRemainingAmount(selectedItem).toFixed(2)}</p>
                      </div>

                      {error && (
                        <div className="mb-4 p-3 bg-red-100 border border-red-300 rounded-md">
                          <p className="text-red-800 text-sm">{error}</p>
                        </div>
                      )}

                      <div className="mb-4">
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Your Name
                        </label>
                        <input
                          type="text"
                          value={guestName}
                          onChange={(e) => setGuestName(e.target.value)}
                          className="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-rose-500"
                          placeholder="Enter your name"
                          disabled={saving}
                        />
                      </div>

                      <div className="mb-6">
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Contribution Amount
                        </label>
                        <input
                          type="number"
                          value={contributionAmount}
                          onChange={(e) => setContributionAmount(e.target.value)}
                          className="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-rose-500"
                          placeholder="0.00"
                          min="1"
                          max={getRemainingAmount(selectedItem)}
                          step="0.01"
                          disabled={saving}
                        />
                      </div>

                      <div className="flex space-x-3">
                        <button
                          onClick={() => setShowContributionModal(false)}
                          className="flex-1 bg-gray-200 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-300 transition-colors"
                          disabled={saving}
                        >
                          Cancel
                        </button>
                        <button
                          onClick={handleContribution}
                          disabled={!guestName || !contributionAmount || parseFloat(contributionAmount) <= 0 || saving}
                          className="flex-1 bg-rose-500 text-white py-2 px-4 rounded-md hover:bg-rose-600 transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed"
                        >
                          {saving ? '‚è≥ Saving...' : 'Contribute'}
                        </button>
                      </div>
                    </div>
                  </div>
                )}

                {showAdminPanel && (
                  <div className="bg-red-50 border-2 border-red-200 rounded-lg p-6 mt-8">
                    <div className="flex justify-between items-center mb-4">
                      <h3 className="text-xl font-semibold text-red-800">üîí Admin: Contributor Details</h3>
                      <div className="flex space-x-2">
                        <button 
                          onClick={loadDataFromFirebase}
                          className="text-blue-600 hover:text-blue-800 text-sm px-3 py-1 bg-blue-100 rounded"
                          disabled={loading}
                        >
                          {loading ? '‚è≥' : 'üîÑ Refresh Data'}
                        </button>
                        <button 
                          onClick={() => setShowAdminPanel(false)}
                          className="text-red-600 hover:text-red-800"
                        >
                          ‚úï Close
                        </button>
                      </div>
                    </div>
                    <div className="text-sm text-red-600 mb-4">
                      Press Ctrl+Shift+A to toggle this panel | Firebase: {window.firebaseDB ? '‚úÖ Connected' : '‚ùå Not configured'}
                    </div>
                    
                    {items.filter(item => item.contributions.length > 0).length === 0 ? (
                      <p className="text-gray-600 italic">No contributions yet</p>
                    ) : (
                      items.filter(item => item.contributions.length > 0).map(item => (
                        <div key={item.id} className="mb-4 p-4 bg-white border rounded">
                          <h4 className="font-medium text-gray-800 mb-2">{item.item}</h4>
                          <div className="space-y-1">
                            {item.contributions.map((contrib, index) => (
                              <div key={index} className="flex justify-between text-sm">
                                <span className="text-gray-700">{contrib.name}</span>
                                <span className="font-medium text-green-600">¬£{contrib.amount.toFixed(2)}</span>
                              </div>
                            ))}
                          </div>
                          <div className="mt-2 pt-2 border-t text-sm font-medium">
                            Total for this item: ¬£{getTotalContributed(item).toFixed(2)}
                          </div>
                        </div>
                      ))
                    )}
                    
                    {items.filter(item => item.contributions.length > 0).length > 0 && (
                      <div className="mt-6 p-4 bg-green-50 border border-green-200 rounded">
                        <h4 className="font-medium text-green-800 mb-2">Summary</h4>
                        <div className="text-sm">
                          <p>Total contributions: ¬£{items.reduce((total, item) => total + getTotalContributed(item), 0).toFixed(2)}</p>
                          <p>Number of contributors: {items.reduce((total, item) => total + item.contributions.length, 0)}</p>
                          <p>Items with contributions: {items.filter(item => item.contributions.length > 0).length}</p>
                        </div>
                      </div>
                    )}
                  </div>
                )}

                <div className="text-center mt-12 p-6 bg-white rounded-lg shadow-lg">
                  <p className="text-gray-600 mb-2">
                    Your generosity means everything to us! If you have any questions, please don't hesitate to reach out.
                  </p>
                  <p className="text-rose-600 font-medium">With love, Clara & Ross ‚ù§Ô∏è</p>
                </div>
              </div>
            </div>
          );
        };

        ReactDOM.render(<WeddingGiftRegistry />, document.getElementById('root'));
    </script>
</body>
</html>
